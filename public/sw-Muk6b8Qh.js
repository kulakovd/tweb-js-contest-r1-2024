const T={test:location.search.indexOf("test=1")>0,debug:location.search.indexOf("debug=1")>0,http:!1,ssl:!0,asServiceWorker:!1,transport:"websocket",noSharedWorker:location.search.indexOf("noSharedWorker=1")>0,multipleTransports:!0};(T.http=location.search.indexOf("http=1")>0)&&(T.multipleTransports=!1);T.multipleTransports&&(T.http=!0);T.http&&(T.transport="https");const X=T.debug,Ce=typeof window<"u"?window:self,ee=Ce,b=typeof window<"u"?window:self,W=navigator?navigator.userAgent:null;navigator.userAgent.search(/OS X|iPhone|iPad|iOS/i);navigator.userAgent.toLowerCase().indexOf("android");(()=>{try{return+navigator.userAgent.match(/Chrom(?:e|ium)\/(.+?)(?:\s|\.)/)[1]}catch{}})();const re="safari"in b||!!(W&&(/\b(iPad|iPhone|iPod)\b/.test(W)||W.match("Safari")&&!W.match("Chrome"))),oe=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;(navigator.maxTouchPoints===void 0||navigator.maxTouchPoints>0)&&navigator.userAgent.search(/iOS|iPhone OS|Android|BlackBerry|BB10|Series ?[64]0|J2ME|MIDP|opera mini|opera mobi|mobi.+Gecko|Windows Phone/i)!=-1;const D=typeof ServiceWorkerGlobalScope<"u"&&self instanceof ServiceWorkerGlobalScope,U=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&!D,_e=U||D,ae=()=>self.clients.matchAll({includeUncontrolled:!1,type:"window"}),ce=(s,...e)=>{try{s.postMessage(...e)}catch(t){console.error("[worker] postMessage error:",t,e)}},le=(s,...e)=>{ae().then(t=>{t.length&&t.slice(s?0:-1).forEach(n=>{ce(n,...e)})})},he=(...s)=>{ce(self,...s)},ue=()=>{};D&&le.bind(null,!1);D&&le.bind(null,!0);const Ie=Date.now();function te(){return"["+((Date.now()-Ie)/1e3).toFixed(3)+"]"}var _=(s=>(s[s.None=0]="None",s[s.Error=1]="Error",s[s.Warn=2]="Warn",s[s.Log=4]="Log",s[s.Debug=8]="Debug",s))(_||{});const Oe=[0,1,2,4,8],xe=re||oe,Me=!xe,se={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",underscore:"\x1B[4m",blink:"\x1B[5m",reverse:"\x1B[7m",hidden:"\x1B[8m",fg:{black:"\x1B[30m",red:"\x1B[31m",green:"\x1B[32m",yellow:"\x1B[33m",blue:"\x1B[34m",magenta:"\x1B[35m",cyan:"\x1B[36m",white:"\x1B[37m"},bg:{black:"\x1B[40m",red:"\x1B[41m",green:"\x1B[42m",yellow:"\x1B[43m",blue:"\x1B[44m",magenta:"\x1B[45m",cyan:"\x1B[46m",white:"\x1B[47m"}},Re=[["debug",8],["info",4],["warn",2],["error",1],["assert",1],["trace",4],["group",4],["groupCollapsed",4],["groupEnd",4]];function L(s,e=7,t=!1,n=""){let i;!X&&!t&&(e=1),Me?n||(D?n=se.fg.yellow:U&&(n=se.fg.cyan)):n="";const r=n;n?n=`%s ${n}%s`:n="%s";const o=function(...a){return e&4&&console.log(n,te(),s,...a)};return Re.forEach(([a,c])=>{o[a]=function(...l){return e&c&&console[a](n,te(),s,...l)}}),o.setPrefix=function(a){i=a,s="["+a+"]"},o.setPrefix(s),o.setLevel=function(a){e=Oe.slice(0,a+1).reduce((c,l)=>c|l,0)},o.bindPrefix=function(a,c=e){return L(`${i}] [${a}`,c,t,r)},o}function de(s){return new Promise(e=>{setTimeout(e,s)})}const De=self,fe="cachedAssets";function G(s){return s.ok&&s.status===200}function ne(s){return Promise.race([s,de(1e4).then(()=>Promise.reject())])}async function Le(s){try{const e=await ne(De.caches.open(fe)),t=await ne(e.match(s.request,{ignoreVary:!0}));if(t&&G(t))return t;const n={Vary:"*"};let i=await fetch(s.request,{headers:n});if(G(i))e.put(s.request,i.clone());else if(i.status===304){const r=s.request.url.replace(/\?.+$/,"")+"?"+(Math.random()*1e5|0);i=await fetch(r,{headers:n}),G(i)&&e.put(s.request,i.clone())}return i}catch{return fetch(s.request)}}function Ne(s,e){return new Promise(t=>{const n=new FileReader;n.addEventListener("loadend",i=>{t(i.target.result)}),n[e](s)})}function We(s){return Ne(s,"readAsArrayBuffer")}function Fe(s){return We(s).then(e=>new Uint8Array(e))}function ge(){}const Be={isFulfilled:!1,isRejected:!1,notify:()=>{},notifyAll:function(...s){this.lastNotify=s,this.listeners?.forEach(e=>e(...s))},addNotifyListener:function(s){this.lastNotify&&s(...this.lastNotify),(this.listeners??(this.listeners=[])).push(s)},resolve:function(s){this.isFulfilled||this.isRejected||(this.isFulfilled=!0,this._resolve(s),this.onFinish())},reject:function(...s){this.isRejected||this.isFulfilled||(this.isRejected=!0,this._reject(...s),this.onFinish())},onFinish:function(){this.notify=this.notifyAll=this.lastNotify=null,this.listeners&&(this.listeners.length=0),this.cancel&&(this.cancel=ge)}};function j(){let s,e;const t=new Promise((n,i)=>{s=n,e=i});return Object.assign(t,Be),t._resolve=s,t._reject=e,t}self.deferredPromise=j;function Ue(s,e,t=!0,n=!0){let i,r,o,a,c=!1;const l=h=>{const p=o,g=a;try{const d=s.apply(null,h);p(d)}catch(d){console.error("debounce error",d),g(d)}},f=(...h)=>{r||(r=new Promise((g,d)=>(o=g,a=d))),i?(clearTimeout(i),c=!0,a(),r=new Promise((g,d)=>(o=g,a=d))):t&&(l(h),c=!1);const p=b.setTimeout(()=>{n&&(!t||c)&&l(h),i===p&&(i=r=o=a=void 0,c=!1)},e);return i=p,r.catch(ge),r};return f.clearTimeout=()=>{i&&(b.clearTimeout(i),a(),i=r=o=a=void 0,c=!1)},f.isDebounced=()=>!!i,f}function je(s){return["image/jpeg","image/png","image/gif","image/svg+xml","image/webp","image/bmp","video/mp4","video/webm","video/quicktime","audio/ogg","audio/mpeg","audio/mp4","audio/wav","application/json","application/pdf"].indexOf(s)===-1?"application/octet-stream":s}function pe(s,e=""){Array.isArray(s)||(s=[s]);const t=je(e);return new Blob(s,{type:t})}class qe{constructor(e,t,n){this.mimeType=e,this.size=t,this.saveFileCallback=n,this.bytes=new Uint8Array(t)}async write(e,t){const n=t+e.byteLength;if(n>this.bytes.byteLength){const i=new Uint8Array(n);i.set(this.bytes,0),this.bytes=i}this.bytes.set(e,t)}truncate(){this.bytes=new Uint8Array}trim(e){this.bytes=this.bytes.slice(0,e)}finalize(e=!0){const t=pe(this.bytes,this.mimeType);return e&&this.saveFileCallback&&this.saveFileCallback(t),t}getParts(){return this.bytes}replaceParts(e){this.bytes=e}}const $={};function M(s){return $[s]??($[s]={type:s})}const E=class E{constructor(e){this.dbName=e,this.useStorage=!0,T.test&&(this.dbName+="_test"),E.STORAGES.length&&(this.useStorage=E.STORAGES[0].useStorage),this.openDatabase(),E.STORAGES.push(this)}openDatabase(){return this.openDbPromise??(this.openDbPromise=caches.open(this.dbName))}delete(e){return this.timeoutOperation(t=>t.delete("/"+e))}deleteAll(){return caches.delete(this.dbName)}get(e){return this.timeoutOperation(t=>t.match("/"+e))}save(e,t){return this.timeoutOperation(n=>n.put("/"+e,t))}getFile(e,t="blob"){return this.get(e).then(n=>{if(!n)throw M("NO_ENTRY_FOUND");return n[t]()})}saveFile(e,t){t instanceof Blob||(t=pe(t));const n=new Response(t,{headers:{"Content-Length":""+t.size}});return this.save(e,n).then(()=>t)}timeoutOperation(e){return this.useStorage?new Promise(async(t,n)=>{let i=!1;const r=setTimeout(()=>{n(),i=!0},15e3);try{const o=await this.openDatabase();if(!o)throw this.useStorage=!1,this.openDbPromise=void 0,"no cache?";const a=await e(o);if(i)return;t(a)}catch(o){n(o)}clearTimeout(r)}):Promise.reject(M("STORAGE_OFFLINE"))}prepareWriting(e,t,n){return{deferred:j(),getWriter:()=>new qe(n,t,r=>this.saveFile(e,r).catch(()=>r))}}static toggleStorage(e,t){return Promise.all(this.STORAGES.map(n=>{if(n.useStorage=e,!!t&&!e)return n.deleteAll()}))}};E.STORAGES=[];let F=E;function Ge(s){return new Promise(e=>{setTimeout(()=>{e(new Response("",{status:408,statusText:"Request timed out."}))},s)})}function $e(s){function e(h,p){const g=new Uint8Array(h);for(let d=0;d<=g.length-4;d++)if(g[d]===p[0]&&g[d+1]===p[1]&&g[d+2]===p[2]&&g[d+3]===p[3])return d;return-1}function t(h,p){let g=!1;for(;!g;){const d=p.getUint8(h);h++,d&128||(g=!0)}return h}let i=e(s,[101,115,100,115]);if(i===-1)return!1;const r=new DataView(s);if(i+=8,r.getUint8(i)!==3||(i++,i=t(i,r),i+=3,r.getUint8(i)!==4)||(i++,i=t(i,r),i+=13,r.getUint8(i)!==5))return!1;i++,i=t(i,r);const l=r.getUint8(i),f=r.getUint8(i+1);return l===19&&f===136&&r.setUint8(i+1,152),!0}const I=new Map,K=new F("cachedStreamChunks"),Ve=86400,me="Time-Cached",ze=()=>K.timeoutOperation(s=>s.keys().then(e=>{const t=new Map,n=Date.now()/1e3|0;for(const r of e){const o=r.url.match(/\/(\d+?)\?/);o&&!t.has(o[1])&&t.set(o[1],r)}const i=[];for(const[r,o]of t){const a=s.match(o).then(c=>{if(+c.headers.get(me)+Ve<=n)return u("will delete stream chunk:",r),s.delete(o,{ignoreSearch:!0,ignoreVary:!0})});i.push(a)}return Promise.all(i)}));setInterval(ze,18e5);setInterval(()=>{const s=be();for(const[e,t]of I)if(e!==s){for(const n in t)t[n].reject();I.delete(e)}},12e4);const V=new Map;class B{constructor(e){this.info=e,this.loadedOffsets=new Set,this.destroy=()=>{V.delete(this.id)},this.id=B.getId(e),V.set(this.id,this),this.limitPart=e.size>75*1024*1024?Je:Ye,this.destroyDebounced=Ue(this.destroy,15e4,!1,!0)}async requestFilePartFromWorker(e,t,n=!1){const i={docId:this.id,dcId:this.info.dcId,offset:e,limit:t},r=JSON.stringify(i),o=be();let a=I.get(o);a||I.set(o,a={});let c=a[r];if(c)return c.then(f=>f.bytes);this.loadedOffsets.add(e),c=a[r]=j(),w.invoke("requestFilePart",i,void 0,o).then(c.resolve.bind(c),c.reject.bind(c)).finally(()=>{a[r]===c&&(delete a[r],Object.keys(a).length||I.delete(o))});const l=c.then(f=>f.bytes);return this.saveChunkToCache(l,e,t),!n&&this.preloadChunks(e,e+this.limitPart*15),l}requestFilePartFromCache(e,t,n){const i=this.getChunkKey(e,t);return K.getFile(i).then(r=>n?new Uint8Array:Fe(r),r=>{r.type})}requestFilePart(e,t,n){return this.requestFilePartFromCache(e,t,n).then(r=>r||this.requestFilePartFromWorker(e,t,n))}saveChunkToCache(e,t,n){return e.then(i=>{const r=this.getChunkKey(t,n),o=new Response(i,{headers:{"Content-Length":""+i.length,"Content-Type":"application/octet-stream",[me]:""+(Date.now()/1e3|0)}});return K.save(r,o)})}preloadChunk(e){this.loadedOffsets.has(e)||(this.loadedOffsets.add(e),this.requestFilePart(e,this.limitPart,!0))}preloadChunks(e,t){if(t>this.info.size&&(t=this.info.size),!e)this.preloadChunk(ie(e,this.limitPart));else for(;e<t;e+=this.limitPart)this.preloadChunk(e)}requestRange(e){this.destroyDebounced();const t=Ke(e,this.info.mimeType,this.info.size);if(t)return t;let[n,i]=e;const r=i&&i<this.limitPart?Ze(i-n+1):this.limitPart,o=ie(n,r);return i||(i=Math.min(n+r,this.info.size-1)),this.requestFilePart(o,r).then(a=>{(n!==o||i!==o+r)&&(a=a.slice(n-o,i-o+1)),this.info.mimeType==="video/mp4"&&$e(a.buffer);const c={"Accept-Ranges":"bytes","Content-Range":`bytes ${n}-${n+a.byteLength-1}/${this.info.size||"*"}`,"Content-Length":`${a.byteLength}`};return this.info.mimeType&&(c["Content-Type"]=this.info.mimeType),new Response(a,{status:206,statusText:"Partial Content",headers:c})})}getChunkKey(e,t){return this.id+"?offset="+e+"&limit="+t}static get(e){return V.get(this.getId(e))??new B(e)}static getId(e){return e.location.id}}function He(s,e){const t=Qe(s.request.headers.get("Range")),n=JSON.parse(decodeURIComponent(e)),i=B.get(n);s.respondWith(Promise.race([Ge(45*1e3),i.requestRange(t)]))}function Ke(s,e,t){return s[0]===0&&s[1]===1?new Response(new Uint8Array(2).buffer,{status:206,statusText:"Partial Content",headers:{"Accept-Ranges":"bytes","Content-Range":`bytes 0-1/${t||"*"}`,"Content-Length":"2","Content-Type":e||"video/mp4"}}):null}const Ye=512*1024,Je=1024*1024,Xe=512*4;function Qe(s){if(!s)return[0,0];const[,e]=s.split("="),t=e.split(", "),[n,i]=t[0].split("-");return[+n,+i||0]}function ie(s,e=Xe){return s-s%e}function Ze(s){return 2**Math.ceil(Math.log(s)/Math.log(2))}const et={name:"tweb",version:7,stores:[{name:"session"},{name:"stickerSets"},{name:"users"},{name:"chats"},{name:"dialogs"},{name:"messages"}]},tt="assets/img/logo_filled_rounded.png",st="assets/img/logo_plain.svg";function we(s,e,t){const n=t&&new Set(t),i=c=>Object.keys(c).filter(l=>c[l]!==void 0),r=t?c=>i(c).filter(l=>!n.has(l)):i,o=typeof s;return s&&e&&o==="object"&&o===typeof e?r(s).length===r(e).length&&r(s).every(c=>we(s[c],e[c],t)):s===e}function nt(s,e){if(e)for(const t in e)e[t]!==void 0&&(s[t]=e[t]);return s}const x=class x{constructor(e){nt(this,e),T.test&&(this.name+="_test"),this.storageIsAvailable=!0,this.log=L(["IDB",e.name].join("-")),this.log("constructor"),this.openDatabase(!0),x.INSTANCES.push(this)}isAvailable(){return this.storageIsAvailable}openDatabase(e=!1){if(this.openDbPromise&&!e)return this.openDbPromise;const t=(o,a)=>{const c=Array.from(o.indexNames);for(const l of c)o.deleteIndex(l);if(a.indexes?.length)for(const l of a.indexes)o.indexNames.contains(l.indexName)||o.createIndex(l.indexName,l.keyPath,l.objectParameters)},n=(o,a)=>{const c=o.createObjectStore(a.name);t(c,a)};try{var i=indexedDB.open(this.name,this.version);if(!i)return Promise.reject()}catch(o){return this.log.error("error opening db",o.message),this.storageIsAvailable=!1,Promise.reject(o)}let r=!1;return setTimeout(()=>{r||i.onerror(M("IDB_CREATE_TIMEOUT"))},3e3),this.openDbPromise=new Promise((o,a)=>{i.onsuccess=c=>{r=!0;const l=i.result;let f=!1;this.log("Opened"),l.onerror=h=>{this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",h),a(h)},l.onclose=h=>{this.log.error("closed:",h),!f&&this.openDatabase()},l.onabort=h=>{this.log.error("abort:",h);const p=h.target;this.openDatabase(f=!0),p.onerror&&p.onerror(h),l.close()},l.onversionchange=h=>{this.log.error("onversionchange, lol?")},o(this.db=l)},i.onerror=c=>{r=!0,this.storageIsAvailable=!1,this.log.error("Error creating/accessing IndexedDB database",c),a(c)},i.onupgradeneeded=c=>{r=!0,this.log.warn("performing idb upgrade from",c.oldVersion,"to",c.newVersion);const l=c.target,f=l.result;this.stores.forEach(h=>{if(!f.objectStoreNames.contains(h.name))n(f,h);else{const g=l.transaction.objectStore(h.name);t(g,h)}})}})}static create(e){return this.INSTANCES.find(t=>t.name===e.name)??new x(e)}static closeDatabases(e){this.INSTANCES.forEach(t=>{if(e&&e===t)return;const n=t.db;n&&(n.onclose=()=>{},n.close())})}};x.INSTANCES=[];let Y=x;class it{constructor(e,t){this.storeName=t,this.log=L(["IDB",e.name,t].join("-")),this.idb=Y.create(e)}delete(e,t){const n=Array.isArray(e);return n||(e=[].concat(e)),this.getObjectStore("readwrite",i=>{const r=e.map(o=>i.delete(o));return n?r:r[0]},"",t)}clear(e){return this.getObjectStore("readwrite",t=>t.clear(),"",e)}save(e,t,n){const i=Array.isArray(e);return i||(e=[].concat(e),t=[].concat(t)),this.getObjectStore("readwrite",r=>{const o=e.map((a,c)=>r.put(t[c],a));return i?o:o[0]},"",n)}get(e,t){const n=Array.isArray(e);if(n){if(!e.length)return Promise.resolve([])}else{if(!e)return;e=[].concat(e)}return this.getObjectStore("readonly",i=>{const r=e.map(o=>i.get(o));return n?r:r[0]},"",t)}getObjectStore(e,t,n,i=this.storeName){let r;return n&&(r=performance.now(),this.log(n+": start")),this.idb.openDatabase().then(o=>new Promise((a,c)=>{const l=o.transaction([i],e),f=()=>{clearTimeout(g),c(l.error)},h=()=>{clearTimeout(g),n&&this.log(n+": end",performance.now()-r);const y=q.map(N=>N.result);a(Q?y:y[0])};l.onerror=f;const p=e==="readwrite";p&&(l.oncomplete=()=>h());const g=setTimeout(()=>{this.log.error("transaction not finished",l,n)},1e4),d=t(l.objectStore(i)),Q=Array.isArray(d),q=Q?d:[].concat(d);if(p)return;const Z=q.length;let Ee=Z;const Ae=()=>{l.error||--Ee||h()};for(let y=0;y<Z;++y){const N=q[y];N.onerror=f,N.onsuccess=Ae}}))}getAll(e){return this.getObjectStore("readonly",t=>t.getAll(),"",e)}}const k=self,rt=location.protocol+"//"+location.hostname+location.pathname.split("/").slice(0,-1).join("/")+"/",ot=11500;let ke=0,ve=!0;class at{constructor(e,t,n){this.defaults=n,this.cache={},this.storage=new it(e,t)}getDefault(e){const t=this.defaults[e];return typeof t=="function"?t():t}get(e){return this.cache.hasOwnProperty(e)?this.cache[e]:this.storage.get(e).then(n=>n,()=>{}).then(n=>this.cache.hasOwnProperty(e)?this.cache[e]:(n??(n=this.getDefault(e)),this.cache[e]=n))}getCached(e){const t=this.get(e);if(t instanceof Promise)throw"no property";return t}async set(e,t){const n=this.cache[e]??this.defaults[e];if(!we(n,t)){this.cache[e]=t;try{this.storage.save(e,t)}catch{}}}}const Pe={push_mute_until:0,push_lang:{push_message_nopreview:"You have a new message",push_action_mute1d:"Mute for 24H",push_action_settings:"Settings"},push_settings:{}},S=new at(et,"session",Pe);for(const s in Pe)S.get(s);k.addEventListener("push",s=>{const e=s.data.json();u("push",{...e});try{const[t,n,i]=[S.getCached("push_mute_until"),S.getCached("push_settings"),S.getCached("push_lang")],r=Date.now();if(Te()&&t&&r<t)throw`supress notification because mute for ${Math.ceil((t-r)/6e4)} min`;if(Date.now()-ke<=ot&&ve)throw"supress notification because some instance is alive";const a=ut(e,n,i);s.waitUntil(a)}catch(t){u(t)}});k.addEventListener("notificationclick",s=>{const e=s.notification;u("on notification click",e),e.close();const t=s.action;if(t==="mute1d"&&Te()){u("[SW] mute for 1d"),S.set("push_mute_until",Date.now()+864e5);return}const n=e.data;if(!n)return;const i=k.clients.matchAll({type:"window"}).then(r=>{n.action=t,A=n;for(let o=0;o<r.length;++o){const a=r[o];if("focus"in a){a.focus(),w.invokeVoid("pushClick",A,a),A=void 0;return}}if(k.clients.openWindow)return Promise.resolve(S.get("push_settings")).then(o=>k.clients.openWindow(o.baseUrl||rt))}).catch(r=>{u.error("Clients.matchAll error",r)});s.waitUntil(i)});k.addEventListener("notificationclose",ct);const J=new Set;let A;function ct(s){lt(s.notification)}function lt(s){J.delete(s)}function ht(s){for(const t of J)try{if(s&&t.tag!==s)continue;t.close(),J.delete(t)}catch{}let e;return"getNotifications"in k.registration?e=k.registration.getNotifications({tag:s}).then(t=>{for(let n=0,i=t.length;n<i;++n)try{t[n].close()}catch{}}).catch(t=>{u.error("Offline register SW error",t)}):e=Promise.resolve(),e}function Te(){return oe}function ut(s,e,t){let n=s.title||"Telegram",i=s.description||"",r;s.custom&&(s.custom.channel_id?r=""+-s.custom.channel_id:s.custom.chat_id?r=""+-s.custom.chat_id:r=s.custom.from_id||""),s.custom.peerId=""+r;let o="peer"+r;const a=r+"_"+s.custom.msg_id;if(R.has(a)){const h="ignoring push";throw u.warn(h,s),R.delete(a),h}e?.nopreview&&(n="Telegram",i=t.push_message_nopreview,o="unknown_peer");const c=[{action:"mute1d",title:t.push_action_mute1d}],l={body:i,icon:tt,tag:o,data:s,actions:c,badge:st,silent:s.custom.silent==="1"};return u("show notify",n,i,s,l),k.registration.showNotification(n,l).catch(h=>{u.error("Show notification promise",h)})}function dt(s,e){ke=Date.now(),ve=s.localNotifications,A&&e&&(w.invokeVoid("pushClick",A,e),A=void 0),s.lang&&S.set("push_lang",s.lang),s.settings&&S.set("push_settings",s.settings)}const R=new Map;function ft(s){R.set(s,Date.now())}setInterval(()=>{const s=Date.now();R.forEach((e,t)=>{s-e>3e4&&R.delete(t)})},30*6e4);const gt=Date.now()%Math.random()*1e8|0;function z(s,e){const t=s.indexOf(e);return(t===-1?void 0:s.splice(t,1))?.[0]}function pt(s,e){const t=s.findIndex(e);return t!==-1?s.splice(t,1)[0]:void 0}class mt{constructor(e){this._constructor(e)}_constructor(e){this.reuseResults=e,this.listeners={},this.listenerResults={}}addEventListener(e,t,n){var i;if(((i=this.listeners)[e]??(i[e]=[])).push({callback:t,options:n}),this.listenerResults.hasOwnProperty(e)&&(t(...this.listenerResults[e]),n?.once)){this.listeners[e].pop();return}}addMultipleEventsListeners(e){for(const t in e)this.addEventListener(t,e[t])}removeEventListener(e,t,n){this.listeners[e]&&pt(this.listeners[e],i=>i.callback===t)}invokeListenerCallback(e,t,...n){let i,r;try{i=t.callback(...n)}catch(o){r=o}if(t.options?.once&&this.removeEventListener(e,t.callback),r)throw r;return i}_dispatchEvent(e,t,...n){this.reuseResults&&(this.listenerResults[e]=n);const i=t&&[],r=this.listeners[e];return r&&r.slice().forEach(a=>{if(r.findIndex(f=>f.callback===a.callback)===-1)return;const l=this.invokeListenerCallback(e,a,...n);i&&i.push(l)}),i}dispatchResultableEvent(e,...t){return this._dispatchEvent(e,!0,...t)}dispatchEvent(e,...t){this._dispatchEvent(e,!1,...t)}cleanup(){this.listeners={},this.listenerResults={}}}const wt=!0;class kt extends mt{constructor(e){super(!1),this.logSuffix=e,this.onMessage=t=>{const n=t.data,i=t.source||t.currentTarget;this.processTaskMap[n.type](n,i,t)},this.processResultTask=t=>{const{taskId:n,result:i,error:r}=t.payload,o=this.awaiting[n];o&&(this.debug&&this.log.debug("done",o.taskType,i,r),"error"in t.payload?o.reject(r):o.resolve(i),delete this.awaiting[n])},this.processAckTask=t=>{const n=t.payload,i=this.awaiting[n.taskId];if(!i)return;const r=i.resolve,o={cached:n.cached,result:n.cached?"result"in n?Promise.resolve(n.result):Promise.reject(n.error):new Promise((a,c)=>{i.resolve=a,i.reject=c})};r(o),n.cached&&delete this.awaiting[n.taskId]},this.processPingTask=(t,n,i)=>{this.pushTask(this.createTask("pong",void 0),i.source)},this.processPongTask=(t,n,i)=>{const r=this.pingResolves.get(n);r&&(this.pingResolves.delete(n),r())},this.processCloseTask=(t,n,i)=>{this.detachPort(n)},this.processBatchTask=(t,n,i)=>{const r={data:i.data,source:i.source,currentTarget:i.currentTarget};t.payload.forEach(o=>{r.data=o,this.onMessage(r)})},this.processLockTask=(t,n,i)=>{const r=t.payload;this.requestedLocks.has(r)||(this.requestedLocks.set(r,n),navigator.locks.request(r,()=>{this.processCloseTask(void 0,n,void 0),this.requestedLocks.delete(r)}))},this.processInvokeTask=async(t,n,i)=>{const r=t.id,o=t.payload;let a,c,l;o.void||(a={taskId:r},c=this.createTask("result",a)),o.withAck&&(l=this.createTask("ack",{taskId:r,cached:!0}));let f;try{const h=this.listeners[o.type];if(!h?.length)throw new Error("no listener");const p=h[0];let g=this.invokeListenerCallback(o.type,p,o.payload,n,i);if(o.void)return;if(f=g instanceof Promise,l){const d=!f;if(l.payload.cached=d,d&&(l.payload.result=g),this.pushTask(l,n),d)return}f&&(g=await g),a.result=g}catch(h){if(this.log.error("worker task error:",h,t),o.void)return;if(l&&l.payload.cached){l.payload.error=h,this.pushTask(l,n);return}a.error=h}this.pushTask(c,n)},this.listenPorts=[],this.sendPorts=[],this.pingResolves=new Map,this.taskId=0,this.awaiting={},this.pending=new Map,this.log=L("MP"+(e?"-"+e:"")),this.debug=X,this.heldLocks=new Map,this.requestedLocks=new Map,this.processTaskMap={result:this.processResultTask,ack:this.processAckTask,invoke:this.processInvokeTask,ping:this.processPingTask,pong:this.processPongTask,close:this.processCloseTask,lock:this.processLockTask,batch:this.processBatchTask}}setOnPortDisconnect(e){this.onPortDisconnect=e}attachPort(e){this.attachListenPort(e),this.attachSendPort(e)}attachListenPort(e){this.listenPorts.push(e),e.addEventListener("message",this.onMessage)}attachSendPort(e){if(this.log.warn("attaching send port"),e.start?.(),this.sendPorts.push(e),typeof window<"u"&&wt)if("locks"in navigator){const t=["lock",gt,this.logSuffix||"",Math.random()*2147483647|0].join("-");this.log.warn("created lock",t);const n=new Promise(i=>this.heldLocks.set(e,{resolve:i,id:t})).then(()=>this.heldLocks.delete(e));navigator.locks.request(t,()=>(this.resendLockTask(e),n))}else window.addEventListener("beforeunload",()=>{const t=this.createTask("close",void 0);this.postMessage(void 0,t)});this.releasePending()}resendLockTask(e){const t=this.heldLocks.get(e);t&&this.pushTask(this.createTask("lock",t.id),e)}detachPort(e){this.log.warn("disconnecting port"),z(this.listenPorts,e),z(this.sendPorts,e),e.removeEventListener?.("message",this.onMessage),e.close?.(),this.onPortDisconnect?.(e),this.heldLocks.get(e)?.resolve();const n=M("PORT_DISCONNECTED");for(const i in this.awaiting){const r=this.awaiting[i];r.port===e&&(r.reject(n),delete this.awaiting[i])}}postMessage(e,t){(Array.isArray(e)?e:e?[e]:this.sendPorts).forEach(i=>{i.postMessage(t,t.transfer)})}async releasePending(){this.releasingPending||(this.releasingPending=!0,await Promise.resolve(),this.debug&&this.log.debug("releasing tasks, length:",this.pending.size),this.pending.forEach((e,t)=>{let n=e;{let r;n=[],e.forEach(o=>{o.transfer?(r=void 0,n.push(o)):(r||(r=this.createTask("batch",[]),n.push(r)),r.payload.push(o))})}const i=t?[t]:this.sendPorts;i.length&&(n.forEach(r=>{try{this.postMessage(i,r)}catch(o){this.log.error("postMessage error:",o,r,i)}}),this.pending.delete(t))}),this.debug&&this.log.debug("released tasks"),this.releasingPending=!1)}createTask(e,t,n){return{type:e,payload:t,id:this.taskId++,transfer:n}}createInvokeTask(e,t,n,i,r){return this.createTask("invoke",{type:e,payload:t,withAck:n,void:i},r)}pushTask(e,t){let n=this.pending.get(t);n||this.pending.set(t,n=[]),n.push(e),this.releasePending()}invokeVoid(e,t,n,i){const r=this.createInvokeTask(e,t,void 0,!0,i);this.pushTask(r,n)}invoke(e,t,n,i,r){this.debug&&this.log.debug("start",e,t);let o;const a=new Promise((c,l)=>{o=this.createInvokeTask(e,t,n,void 0,r),this.awaiting[o.id]={resolve:c,reject:l,taskType:e,port:i},this.pushTask(o,i)});if(_e){a.finally(()=>{clearInterval(c)});const c=b.setInterval(()=>{this.log.error("task still has no result",o,i)},6e4)}return a}invokeExceptSource(e,t,n){const i=this.sendPorts.slice();z(i,n),i.forEach(r=>{this.invokeVoid(e,t,r)})}}class vt extends kt{constructor(){super("SERVICE"),ee&&(ee.serviceMessagePort=this)}}function Pt(s,e,t){const n=(i,r)=>{s.attachListenPort(i),r&&s.attachSendPort(r),e?.(i)};s.setOnPortDisconnect(t),typeof SharedWorkerGlobalScope<"u"?b.addEventListener("connect",i=>n(i.source,i.source)):typeof ServiceWorkerGlobalScope<"u"?n(b,null):n(b,b)}const m=new Map,H=M("UNKNOWN"),Tt=!1;self.downloadMap=m;const bt={download:s=>{const{id:e}=s;if(m.has(e))return Promise.reject(H);const t=new CountQueuingStrategy({highWaterMark:1}),n=j();n.then(()=>{setTimeout(()=>{m.delete(e)},5e3)},()=>{m.delete(e)});let i;const r=new ReadableStream({start:a=>{i=a},cancel:a=>{n.reject(H)}},t),o={...s,readableStream:r,promise:n,controller:i};return m.set(e,o),n.catch(()=>{throw H})},downloadChunk:({id:s,chunk:e})=>{const t=m.get(s);return t?t.controller.enqueue(e):Promise.reject()},downloadFinalize:s=>{const e=m.get(s);return e?(e.promise.resolve(),e.controller.close()):Promise.reject()},downloadCancel:s=>{const e=m.get(s);if(e)return e.promise.reject(),e.controller.error()}};function St(s){return s.addMultipleEventsListeners(bt),{onDownloadFetch:yt,onClosedWindows:Et}}function yt(s,e){const t=de(100).then(()=>{const n=m.get(e);if(!n||n.used&&!Tt)return;n.used=!0;const i=n.readableStream;return new Response(i,{headers:n.headers})});s.respondWith(t)}function Et(){if(m.size)for(const[s,e]of m)e.controller.error()}const O={};function At(s){return{files:s.getAll("files"),title:s.get("title"),text:s.get("text"),url:s.get("url")}}async function Ct(s,e){try{u("share data",s);const t=At(s);(O[e]??(O[e]=[])).push(t)}catch(t){u.warn("something wrong with the data",t)}}function _t(s){const e=O[s.id];e&&(delete O[s.id],u("releasing share events to client:",s.id,"length:",e.length),e.forEach(t=>{w.invokeVoid("share",t,s)}))}function It(s,e){const t=s.request.formData().then(n=>(Ct(n,s.resultingClientId),Response.redirect("..")));s.respondWith(t)}const u=L("SW",_.Error|_.Debug|_.Log|_.Warn,!0),v=self;let C;const be=()=>C;u("init");const Ot=s=>{const e=new MessageChannel;w.attachPort(C=e.port1),w.invokeVoid("port",void 0,s,[e.port2])},xt=s=>{!P.size&&!C&&(u("sending message port for mtproto"),Ot(s))},Se=s=>{if(u("window connected",s.id,"windows before",P.size),s.frameType==="none"){u.warn("maybe a bugged Safari starting window",s.id);return}u("windows",Array.from(P)),w.invokeVoid("hello",void 0,s),xt(s),P.set(s.id,s),_t(s)},w=new vt;w.addMultipleEventsListeners({notificationsClear:ht,toggleStorages:({enabled:s,clearWrite:e})=>{F.toggleStorage(s,e)},pushPing:(s,e)=>{dt(s,e)},hello:(s,e)=>{Se(e)},shownNotification:ft});const{onDownloadFetch:Mt,onClosedWindows:Rt}=St(w);ae().then(s=>{u(`got ${s.length} windows from the start`),s.forEach(e=>{Se(e)})});const P=new Map;self.connectedWindows=P;Pt(w,void 0,s=>{if(u("something has disconnected",s),!(s instanceof WindowClient)||!P.has(s.id)){u.warn("it is not a window");return}P.delete(s.id),u("window disconnected, left",P.size),P.size||(u.warn("no windows left"),C&&(w.detachPort(C),C=void 0),Rt())});const Dt=s=>{if(!re&&s.request.url.indexOf(location.origin+"/")===0&&s.request.url.match(/\.(js|css|jpe?g|json|wasm|png|mp3|svg|tgs|ico|woff2?|ttf|webmanifest?)(?:\?.*)?$/))return s.respondWith(Le(s));try{const[e,t]=s.request.url.split("/").slice(-2);switch(e){case"stream":{He(s,t);break}case"download":{Mt(s,t);break}case"share":{It(s,t);break}case"ping":{s.respondWith(new Response("pong"));break}}}catch(e){u.error("fetch error",e),s.respondWith(new Response("",{status:500,statusText:"Internal Server Error",headers:{"Cache-Control":"no-cache"}}))}},ye=()=>{v.onfetch=Dt};v.addEventListener("install",s=>{u("installing"),s.waitUntil(v.skipWaiting().then(()=>u("skipped waiting")))});v.addEventListener("activate",s=>{u("activating",v),s.waitUntil(v.caches.delete(fe).then(()=>u("cleared assets cache"))),s.waitUntil(v.clients.claim().then(()=>u("claimed clients")))});v.onoffline=v.ononline=ye;ye();
//# sourceMappingURL=sw-Muk6b8Qh.js.map
